import sys
from dataclasses import dataclass, field
from pathlib import Path

import tyro

# This is a hack so that the script work with azure sdkv2.
# The root folder is _not_ added to the python path as it was in sdkv1
# and thus, local imports of rebel_nerf are not found.
# Remove when https://github.com/Azure/azure-sdk-for-python/issues/29724 is fixed
sys.path.append(".")
sys.path.append("./nerfstudio")


from rebel_nerf.evaluator.evaluator import Evaluator  # noqa: E402
from rebel_nerf.render.renderer import RenderedImageModality, Renderer  # noqa: E402


@dataclass
class EvalCLIArgs:
    """Stores input arguments used for rendering."""

    model_uri: Path
    """Path to model."""
    dataset_path: Path
    """Path to a dataset containing a transforms.json file generated by COLMAP.
    Used to query the dataset first pose to generate a spiral trajectory"""
    output_folder: Path = Path("./outputs")
    """Name of the output folder to save metrics"""
    modalities_to_save: list[RenderedImageModality] = field(
        default_factory=lambda: [
            RenderedImageModality.rgb,
        ]
    )
    """Name of the renderer outputs to use: rgb, depth, accumulation."""


def main() -> None:
    tyro.extras.set_accent_color("bright_yellow")
    parameters = tyro.cli(EvalCLIArgs)

    pipeline, config = Renderer.extract_pipeline(
        parameters.model_uri, parameters.dataset_path
    )
    evaluator = Evaluator(pipeline=pipeline, config=config)

    evaluator.save_metrics(output_folder=parameters.output_folder)
    evaluator.save_images(
        modalities=parameters.modalities_to_save,
        output_path=parameters.output_folder,
    )


if __name__ == "__main__":
    main()
